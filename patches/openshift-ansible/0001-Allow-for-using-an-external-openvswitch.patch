From cc9858ea608780295d1edda7984256ea1e999cb9 Mon Sep 17 00:00:00 2001
From: Flavio Percoco <flaper87@gmail.com>
Date: Wed, 21 Feb 2018 15:29:16 +0100
Subject: [PATCH] Allow for using an external openvswitch

---
 roles/openshift_node/defaults/main.yml          | 1 +
 roles/openshift_node/tasks/container_images.yml | 2 ++
 roles/openshift_node/tasks/systemd_units.yml    | 3 +++
 3 files changed, 6 insertions(+)

diff --git a/roles/openshift_node/defaults/main.yml b/roles/openshift_node/defaults/main.yml
index d5ec27d76..9482b5617 100644
--- a/roles/openshift_node/defaults/main.yml
+++ b/roles/openshift_node/defaults/main.yml
@@ -113,6 +113,7 @@ system_images_registry_dict:
   origin: "docker.io"
 
 system_images_registry: "{{ system_images_registry_dict[openshift_deployment_type | default('origin')] }}"
+openshift_use_external_openvswitch: False
 l_is_openvswitch_system_container: "{{ (openshift_use_openvswitch_system_container | default(openshift_use_system_containers | default(false)) | bool) }}"
 
 openshift_image_tag: ''
diff --git a/roles/openshift_node/tasks/container_images.yml b/roles/openshift_node/tasks/container_images.yml
index bb788e2f1..70a25494a 100644
--- a/roles/openshift_node/tasks/container_images.yml
+++ b/roles/openshift_node/tasks/container_images.yml
@@ -9,6 +9,7 @@
   when:
   - openshift_node_use_openshift_sdn | bool
   - l_is_openvswitch_system_container | bool
+  - not openshift_use_external_openvswitch | bool
 
 - name: Pre-pull openvswitch image
   command: >
@@ -18,3 +19,4 @@
   when:
   - openshift_node_use_openshift_sdn | bool
   - not l_is_openvswitch_system_container | bool
+  - not openshift_use_external_openvswitch | bool
diff --git a/roles/openshift_node/tasks/systemd_units.yml b/roles/openshift_node/tasks/systemd_units.yml
index e33a4999f..abac763d6 100644
--- a/roles/openshift_node/tasks/systemd_units.yml
+++ b/roles/openshift_node/tasks/systemd_units.yml
@@ -15,11 +15,14 @@
 
   - name: include ovs service environment file
     include_tasks: config/install-ovs-service-env-file.yml
+    when:
+    - not openshift_use_external_openvswitch | bool
 
   - include_tasks: config/install-ovs-docker-service-file.yml
     when:
     - openshift_node_use_openshift_sdn | bool
     - not l_is_openvswitch_system_container | bool
+    - not openshift_use_external_openvswitch | bool
 
 - include_tasks: config/configure-node-settings.yml
 - include_tasks: config/configure-proxy-settings.yml
-- 
2.17.0

